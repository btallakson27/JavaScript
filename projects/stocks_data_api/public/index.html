<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Data Web Scraper</title>
  <style>
    body { padding: 20px; font-family: sans-serif; background: linear-gradient( #f2f3f2, #9fc0a1); background-attachment: fixed; }
    header { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;  }
    main { display: flex; justify-content: center; }
    input { flex: 0.1; width: 70%; max-width: 300px; font-size: 16px; padding: 8px; border-radius: 6px; border: 1px solid black; }
    button { font-size: 16px; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    table { width: 70%; max-width: 700px; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }

 @media (min-width: 640px){ /*this is for wider screens*/
      table{
        width: 50%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Stock Data Prices</h1>
    </div>
    <div>
      <input id="ticker" placeholder="Enter stock ticker..." />
      <button id="searchBtn">Search</button>
    </div>
  </header>
  <main></main>

  <script>
    // Grab DOM elements
    const tickerInput = document.getElementById('ticker');
    const searchBtn = document.getElementById('searchBtn');
    const mainContainer = document.querySelector('main');

    // Main function to fetch and display stock data
    async function fetchStockData() {
      const stock_ticker = tickerInput.value.trim();

      if (!stock_ticker) {
        mainContainer.innerText = 'Please enter a stock ticker.';
        return;
      }

      try {
        console.log("fetchStockData() called"); // debugging log. if this prints, it means, “Yes, the code reached this point in the function.”
        console.log("Sending request with:", { stock_ticker }); // debugging log.
        const res = await fetch('/api', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stock_ticker })
        });

        console.log("Response received:", res); // debugging log. 
        console.log("res.ok:", res.ok, "status:", res.status); // debugging log. 

        if (!res.ok) throw new Error(`Server responded with status ${res.status}`); //why not return?

        // makes your frontend bulletproof. NEW
        const contentType = res.headers.get('content-type'); 
        // Get the value of the 'Content-Type' header from the server's response. 
        // This tells you what kind of data the server is sending back (e.g., JSON, HTML, plain text).
        if (!contentType || !contentType.includes('application/json')) { 
          // If there’s no Content-Type header, OR it exists but doesn’t specify JSON format...
          throw new Error(`Unexpected response type: ${contentType}`); 
          // ...then stop the function by throwing an error. 
          // Include the actual Content-Type value in the error message to help debug what the server really sent.
        }

        const data = await res.json();
        console.log("Parsed JSON:", data);

        const prices = Array.isArray(data?.prices) ? data.prices : [];
        console.log("Prices array length:", prices.length);

        if (!prices.length) {
          mainContainer.innerText = 'No data found for this ticker';
          return;
        }

        // ✅ Build and show the table
        buildTable(prices); //NEW

      } catch (err) {
        console.error("Error fetching stock data:", err);
        mainContainer.innerText = 'Error fetching stock data. Please try again.';
      }
    }

    // Helper function to build the stock table
    function buildTable(prices) {
      mainContainer.innerHTML = '';

      if (!Array.isArray(prices) || !prices.length) { //NEW
        mainContainer.innerText = 'No data found for this ticker';
        return;
      }

      const filteredPrices = prices.filter(entry => entry.date && entry.close != null);
      console.log("Filtered prices length:", filteredPrices.length);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      ['Date', 'Close Price'].forEach(text => {
        const th = document.createElement('th');
        th.innerText = text;
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      filteredPrices.forEach(entry => {
        const row = document.createElement('tr');

        const dateCell = document.createElement('td');
        dateCell.innerText = entry.date;

        const closeCell = document.createElement('td');
        closeCell.innerText = `$${entry.close.toFixed(2)}`;

        row.appendChild(dateCell);
        row.appendChild(closeCell);
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      mainContainer.appendChild(table);
    }

    // Add click event listener to button
    searchBtn.addEventListener('click', fetchStockData);
  </script>
</body>
</html>
